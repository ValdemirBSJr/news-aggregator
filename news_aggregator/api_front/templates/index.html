<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Jornal da Tarde - Edi√ß√£o Especial</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@700&family=Merriweather:wght@400;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="jornal-container">

        <header class="cabecalho">
            <h1>O Jornal da Tarde</h1>
            <p class="data-e-edicao">{{ dia_da_semana }}, {{ dia }} de {{ mes }} de {{ ano }} | Edi√ß√£o N¬∞ {{ edicao }} |
                R$ 1,50</p>
            <form method="get" action="{{ url_for('home') }}" class="filtro-data">
                <label for="date-picker">Filtrar por data:</label>
                <input type="date" id="date-picker" name="date" value="{{ selected_date }}">
                <button type="submit">Buscar</button>
            </form>
        </header>

        <main class="secoes-noticias">

            {% if news_items %}
            {% for item in news_items %}
            <article class="noticia" id="article-{{ item.id }}">
                <h2 class="titulo-noticia">{{ item.title | default("T√≠tulo Desconhecido") }}</h2>
                <p class="fonte-e-url">
                    Fonte:
                    <span class="fonte-nome">{{ item.source | default("Desconhecida") }}</span>
                    <a href="{{ item.url | default('#') }}" target="_blank" class="link-original">(Leia Mais)</a>
                </p>
                <p class="descricao" id="desc-{{ item.id }}">
                    {{ item.description | default("Nenhuma descri√ß√£o dispon√≠vel para esta not√≠cia.") }}
                </p>

                <!-- AI A√áOES -->
                <div class="acoes-jornal">
                    {% if item.show_translate %}
                    <button class="btn-jornal" onclick="translateArticle('{{ item.id }}')">[Traduzir]</button>
                    {% endif %}

                    {% if item.show_related %}
                    <button class="btn-jornal" onclick="toggleRelated('{{ item.id }}')">[Ver Relacionadas]</button>
                    {% endif %}
                </div>

                <!-- Related Container -->
                <div id="related-{{ item.id }}" class="secao-relacionadas" style="display: none;">
                    <p class="loading-text">Consultando not√≠cias...</p>
                </div>

                <div class="linha-separadora"></div>
            </article>
            {% endfor %}
            {% else %}
            <div class="erro-mensagem">
                <p>üö® N√£o foi poss√≠vel carregar as not√≠cias do dia.üö® </p>
            </div>
            {% endif %}

        </main>

        <footer class="rodape">
            <p>&copy; {{ ano }} - Todos os direitos reservados. Publicado por W News Network.</p>
        </footer>
    </div>


    <script>
        async function translateArticle(id) {
            const descElement = document.getElementById(`desc-${id}`);
            const currentText = descElement.innerText;

            // Feedback visual simples
            descElement.style.opacity = '0.5';

            try {
                const response = await fetch('/api/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: currentText })
                });
                const data = await response.json();
                if (data.translation) {
                    descElement.innerText = data.translation;
                    descElement.style.fontStyle = 'italic'; // Indicar tradu√ß√£o
                } else {
                    alert('Erro na tradu√ß√£o');
                }
            } catch (e) {
                console.error(e);
                alert('Falha ao conectar servi√ßo de tradu√ß√£o.');
            } finally {
                descElement.style.opacity = '1';
            }
        }

        async function toggleRelated(id) {
            const container = document.getElementById(`related-${id}`);

            if (container.style.display === 'none') {
                container.style.display = 'block';

                // Se j√° carregou, n√£o carrega de novo
                if (!container.dataset.loaded) {
                    try {
                        const response = await fetch('/api/related', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: id })
                        });
                        const data = await response.json();

                        let html = '';
                        if (data.summary) {
                            html += `<div class="resumo-ai"><strong>Resumo das not√≠cias:</strong> ${data.summary}</div>`;
                        }

                        if (data.links && data.links.length > 0) {
                            html += `<div class="lista-relacionadas"><strong>Not√≠cias Correlatas:</strong><ul>`;
                            data.links.forEach(link => {
                                html += `<li><a href="${link.url}" target="_blank">${link.title}</a> <small>(${link.date})</small></li>`;
                            });
                            html += `</ul></div>`;
                        } else {
                            html += `<p>Nenhuma correla√ß√£o encontrada nas not√≠cias recentes.</p>`;
                        }

                        container.innerHTML = html;
                        container.dataset.loaded = "true";

                    } catch (e) {
                        container.innerHTML = "<p>Erro ao consultar not√≠cias.</p>";
                        console.error(e);
                    }
                }
            } else {
                container.style.display = 'none';
            }
        }
    </script>
</body>

</html>